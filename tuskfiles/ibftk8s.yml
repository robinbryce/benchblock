usage: |
  Generate the network wide kustomizations for rrr

args:
  configdir:
    usage: >
      The config root directory.

run:
  - task:
      name: configure
      args:
        - ${configdir}
  - command:
      exec: |
        set -e
        TUSKDIR=$(pwd)

        # read the config file fields into BBAKE_ vars.
        eval ${READ_CONFIG}

        cd ${launchdir} && cd ${configdir}

        export GAS_OPTS="${RECOMMIT:+ --miner.recommit "${BBAKE_RECOMMIT}"} --miner.gastarget ${BBAKE_GASTARGET} --miner.gaslimit ${BBAKE_GASLIMIT}"
        export CONSENSUS_OPTS="\
          ${BBAKE_REQUESTTIMEOUT:+--istanbul.requesttimeout $BBAKE_REQUESTTIMEOUT} \
          ${BBAKE_BLOCKPERIOD:+--istanbul.blockperiod $BBAKE_BLOCKPERIOD}"

        mkdir -p ibft/network

        cat <<END > ibft/network/network.env
        CONSENSUS_OPTS=${CONSENSUS_OPTS}
        NETWORKID=${BBAKE_NETWORKID}
        DISCOVERY_OPTS=--nodiscover
        ETHERBASE=${BBAKE_ETHERBASE}
        GETH_IMAGE= ${BBAKE_GETH_IMAGE}
        GAS_OPTS=$GAS_OPTS
        LOG_OPTS=--vmodule consensus/*=5,miner/*=2,eth/*=2,p2p/discover/*=2 --verbosity 2
        END
        cat ibft/network/network.env
        echo "Wrote ibft/network/network.env"

        cp ${BBAKE_NODESDIR}/genesis.json ibft/network
        cp ${BBAKE_NODESDIR}/static-nodes.json ibft/network

        # this assumes static-nodes.json is generated for compose with the hosts listed in
        # ascending order node0, node1 ...
        # > ethnode8.{BBAKE_NAME}.svc.cluster.local
        cat <<PYEND | python3
        import os, json
        from urllib.parse import urlparse, urlunparse
        nodes = []
        nodesdir = os.environ['BBAKE_NODESDIR']
        namespace = os.environ['BBAKE_NAME']
        numbootnodes = int(os.environ['BBAKE_NUMBOOTNODES'])
        for i, u in enumerate(json.load(open(f"{nodesdir}/static-nodes.json"))):
          u = urlparse(u)
          if u.hostname != f"node{i}":
            print(f"ERROR: static nodes declared in unexpected order or just plain wrong")
            sys.exit(1)

          nodename = f"ethnode{i}"
          u = urlunparse((u.scheme, f"{u.username}@{nodename}-0.{nodename}.{namespace}.svc.cluster.local:{u.port}", '', '', u.query, ''))

          nodes.append(u)
        json.dump(nodes, open("ibft/network/static-nodes.json", "w"), sort_keys=True, indent=True)
        PYEND

        cp -v ibft/network/static-nodes.json jobs/loadtest
        cat base/jobs/loadtest/bbeth.json | jq -r \
          '.bbeth.load.transactions = 10000 |
           .bbeth.load.nodes = (env.BBAKE_MAXNODES|tonumber) |
           .bbeth.load.threads = (env.BBAKE_MAXNODES|tonumber)' \
           > jobs/loadtest/bbeth.json
        echo "Wrote jobs/loadtest/bbeth.json"
        yq eval ".namespace = \"$BBAKE_NAME\"" \
          ${TUSKDIR}/k8s/jobs/loadtest/kustomization.yaml | \
          tee jobs/loadtest/kustomization.yaml
        echo "Wrote jobs/loadtest/kustomization.yaml"

        # kustomizations for the nodes
        start=0
        end=$(($BBAKE_MAXNODES - 1))
        for i in $(seq $start $end); do
          NODENUM=$i yq eval '.nameSuffix = env(NODENUM) |
          .commonLabels.app += env(NODENUM) |
          .commonLabels."app.kubernetes.io/name" += env(NODENUM)' \
            ${TUSKDIR}/k8s/ibft/nodes/node0/kustomization.yaml \
            > ibft/nodes/node${i}/kustomization.yaml
            cat ibft/nodes/node${i}/kustomization.yaml
            echo "Wrote: ibft/nodes/node${i}/kustomization.yaml"
        done

        # volumes for all the nodes. no transformation required
        for i in $(seq 0 $((${BBAKE_MAXNODES} - 1))); do
          cp ${TUSKDIR}/k8s/ibft/nodes/node0/statefulset-volumes.yaml ibft/nodes/node${i}/statefulset-volumes.yaml
          cat ibft/nodes/node${i}/statefulset-volumes.yaml
          echo "Wrote: ibft/nodes/node${i}/statefulset-volumes.yaml"
        done

        for i in $(seq 0 $((${BBAKE_MAXNODES} - 1))); do
        echo "- ./../nodes/node${i}"
        done | \
        yq eval-all 'select(fi==0) *+ {"resources": select(fi==1)}' ${TUSKDIR}/k8s/ibft/network/kustomization.yaml - \
        > ibft/network/kustomization.yaml
        cat ibft/network/kustomization.yaml
        echo "Wrote ibft/network/kustomization.yaml"

        # The namespace is the name - eg ibft7
        yq eval ".namespace = \"$BBAKE_NAME\"" \
          ${TUSKDIR}/k8s/ibft/kustomization.yaml | \
          tee ibft/kustomization.yaml
        echo "Wrote ibft/kustomization.yaml"

        cp ${TUSKDIR}/k8s/ibft/namespace.yaml ibft/
        cat ibft/namespace.yaml
        echo "Wrote ibft/namespace.yaml"
